<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é«˜é€Ÿå†³æ–— Final Mix</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --bg-color: #1a1a1a; --text-color: #ffffff; --accent-red: #ff4757; --accent-green: #2ed573; --bar-bg: #57606f; --btn-color: #3742fa; }
        * { box-sizing: border-box; touch-action: manipulation; user-select: none; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-color); color: var(--text-color); display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; }

        .full-layer { position: fixed; top:0; left:0; width:100%; height:100%; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.95); transition: opacity 0.3s; }
        .hidden { display: none !important; opacity: 0; pointer-events: none; }
        
        #login-input { padding: 15px; font-size: 1.2rem; border-radius: 12px; border: none; text-align: center; width: 80%; max-width: 300px; margin-bottom: 20px; }
        .action-btn { padding: 15px 40px; font-size: 1.5rem; border: none; border-radius: 50px; cursor: pointer; color: #fff; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.5); transition: transform 0.1s; background: var(--accent-green); }
        .action-btn:active { transform: scale(0.95); }

        #battle-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1000; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .battle-icon { font-size: 8rem; position: absolute; opacity: 0; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); text-shadow: 0 0 20px rgba(0,0,0,0.5); }
        
        .icon-left { left: 50%; bottom: 20%; transform: translate(-50%, 100px) scale(0.5); } 
        .icon-right { left: 50%; top: 20%; transform: translate(-50%, -100px) scale(0.5); }
        
        .clash .icon-left { opacity: 1; transform: translate(-50%, -10vh) scale(1.5); } 
        .clash .icon-right { opacity: 1; transform: translate(-50%, 10vh) scale(1.5); }
        
        .anim-win { transform: translate(-50%, -10vh) scale(2.5) !important; z-index: 1010; filter: drop-shadow(0 0 20px gold); transition: all 0.5s; }
        .anim-lose { transform: translate(-50%, 10vh) scale(0) rotate(180deg) !important; opacity: 0 !important; filter: grayscale(100%); transition: all 0.5s; }
        .anim-tie { transform: translate(-50%, 0) scale(1) !important; opacity: 0.6; }

        .arena { display: flex; flex-direction: column-reverse; height: 65vh; width: 100%; justify-content: flex-start; gap: 20px; position: relative; z-index: 1; align-items: center; transition: all 0.4s ease-in-out; padding-top: 40px; }
        
        .player-zone { display: flex; flex-direction: column; align-items: center; width: 85%; position: relative; transition: all 0.4s; }
        .hp-container { width: 100%; height: 25px; background: var(--bar-bg); border-radius: 12px; overflow: hidden; border: 3px solid #2f3542; margin-top: 8px; box-shadow: 0 4px 0 rgba(0,0,0,0.3); }
        .hp-bar { height: 100%; background: var(--accent-green); width: 100%; transition: width 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .hp-text { font-weight: bold; font-size: 1.2rem; margin-top: 5px; }
        .player-name { font-size: 1.5rem; font-weight: 800; text-shadow: 1px 1px 0 #000; }

        .timer-zone { text-align: center; margin: 10px 0; height: 60px; display: flex; align-items: center; justify-content: center; }
        #timer { font-size: 4rem; font-weight: 800; font-variant-numeric: tabular-nums; text-shadow: 2px 2px 0 #000; transition: transform 0.2s; }

        /* --- ç”µè„‘ç«¯å¸ƒå±€è°ƒæ•´ --- */
        @media (min-width: 769px) {
            .arena { flex-direction: row; justify-content: center; align-items: center; height: 80vh; gap: 80px; padding-top: 0; }
            .player-zone { width: 350px; margin: 0; }
            
            /* [ä¿®å¤1] å€’è®¡æ—¶ä½ç½®æ§åˆ¶ */
            /* ä¹‹å‰æ˜¯ top: 50%ï¼Œå¯¼è‡´é®æŒ¡ã€‚ç°åœ¨æ”¹ä¸º 15%ï¼Œç§»åˆ°é¡¶éƒ¨ */
            .timer-zone { 
                position: absolute; 
                top: 15%; /* <--- è¿™é‡Œæ§åˆ¶å€’è®¡æ—¶å‚ç›´ä½ç½® */
                left: 50%; 
                transform: translate(-50%, -50%); 
                z-index: 5; 
            }
            
            .icon-left { left: 20%; top: 50%; bottom: auto; transform: translate(-50%, -50%) scale(0.5); }
            .icon-right { right: 20%; top: 50%; left: auto; transform: translate(50%, -50%) scale(0.5); }
            .clash .icon-left { transform: translate(10vw, -50%) scale(1.5); }
            .clash .icon-right { transform: translate(-10vw, -50%) scale(1.5); }
            .anim-win { transform: translate(0, -50%) scale(2.5) !important; }
            .anim-lose { transform: translate(0, -50%) scale(0) !important; }
        }

        /* --- æš´å‡»ä¸é®ç½©ä¼˜åŒ– --- */
        #crit-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 500; background: rgba(0,0,0,0); transition: background 0.3s; }
        .mode-crit #crit-overlay { background: rgba(0,0,0,0.85); pointer-events: auto; }

        .arena.focus-op .myself, .arena.focus-me #op-zone { opacity: 0; pointer-events: none; transform: scale(0.8); }

        /* [ä¿®å¤2] æš´å‡»æ—¶çš„ç©å®¶æ˜¾ç¤ºä¼˜åŒ– */
        .arena.focus-op #op-zone, .arena.focus-me .myself { 
            position: fixed; 
            top: 40%; /* <--- ä¸Šç§»ä¸€ç‚¹ï¼Œé¿å…è¢«åº•éƒ¨çš„ Smash æŒ‰é’®æŒ¡ä½åå­— */
            left: 50%; 
            transform: translate(-50%, -50%) scale(1.4) !important; 
            z-index: 1600; /* <--- æé«˜å±‚çº§ï¼Œç¡®ä¿åœ¨é»‘è‰²é®ç½©ä¹‹ä¸Š */
            width: 80%; 
            max-width: 400px; 
            /* å¢åŠ å¼ºçƒˆçš„é˜´å½±ï¼Œç¡®ä¿å­—è¿¹æ¸…æ™° */
            text-shadow: 0 0 10px rgba(0,0,0,0.8), 0 0 20px rgba(0,0,0,0.5); 
            filter: drop-shadow(0 0 30px rgba(255, 255, 255, 0.15));
        }

        #crit-controls { position: fixed; bottom: 30px; width: 100%; display: flex; justify-content: center; z-index: 1500; pointer-events: none; opacity: 0; transition: opacity 0.2s; }
        .mode-crit #crit-controls { opacity: 1; pointer-events: auto; }

        #btn-smash {
            width: 140px; height: 140px; background: radial-gradient(circle at 30% 30%, #ff6b81, #ff4757);
            border: 6px solid #fff; border-radius: 50%; font-size: 2rem; font-weight: 900; color: white;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5), 0 0 30px #ff4757; cursor: pointer; display: flex; align-items: center; justify-content: center;
            animation: pulse-btn 0.2s infinite alternate;
        }
        #btn-smash:active { transform: scale(0.9); background: #e04050; }
        @keyframes pulse-btn { from { transform: scale(1); } to { transform: scale(1.1); } }

        #defend-msg { font-size: 3rem; color: #ff4757; font-weight: 900; text-transform: uppercase; animation: shake-hard 0.2s infinite; text-shadow: 2px 2px 0 black; padding: 20px; background: rgba(0,0,0,0.5); border-radius: 10px; }

        .controls { display: flex; gap: 20px; justify-content: center; position: fixed; bottom: 40px; width: 100%; z-index: 100; transition: opacity 0.2s; }
        .mode-crit .controls { opacity: 0; pointer-events: none; }
        
        .btn-move { 
            width: 80px; height: 80px; border-radius: 50%; font-size: 2.5rem; border: none; background: var(--btn-color); cursor: pointer; 
            transition: all 0.1s; box-shadow: 0 6px 0 #1e272e, 0 10px 20px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;
        }
        .btn-move:active { transform: translateY(6px); box-shadow: 0 0 0; }
        .btn-move.selected { background: #2ed573; transform: translateY(6px); box-shadow: 0 0 0; border: 3px solid white; }
        .btn-move.dimmed { opacity: 0.3; transform: scale(0.9); filter: grayscale(1); pointer-events: none; }

        .bubble { position: absolute; font-size: 2rem; background: white; border-radius: 50%; width: 50px; height: 50px; display: flex; justify-content: center; align-items: center; opacity: 0; transform: scale(0); transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 20; box-shadow: 0 5px 10px rgba(0,0,0,0.3); color: #000; }
        .bubble.show { opacity: 1; transform: scale(1); }
        #my-bubble { top: -20px; right: 10px; } #op-bubble { top: auto; bottom: -20px; left: 10px; }
        .bubble::after { content: ''; position: absolute; border: 8px solid transparent; }
        #my-bubble::after { border-top-color: white; bottom: -14px; left: 20px; } #op-bubble::after { border-bottom-color: white; top: -14px; right: 20px; }

        .dmg-popup { position: absolute; color: #ff4757; font-weight: 900; font-size: 3rem; pointer-events: none; animation: float-up 0.8s forwards; text-shadow: 2px 2px 0 #fff, 0 0 10px #ff0000; z-index: 2000; }
        @keyframes float-up { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-100px) scale(1.5); opacity: 0; } }
        
        .shake-screen { animation: shake-hard 0.05s infinite; }
        @keyframes shake-hard { 0% { transform: translate(3px, 3px); } 25% { transform: translate(-3px, -3px); } 50% { transform: translate(3px, -3px); } 75% { transform: translate(-3px, 3px); } 100% { transform: translate(0, 0); } }

        #status-bar { position: fixed; top: 15vh; width: 100%; text-align: center; color: #f1c40f; font-weight: bold; font-size: 1.5rem; text-shadow: 0 2px 4px rgba(0,0,0,0.8); z-index: 900; pointer-events: none; }
    </style>
</head>
<body>
    <div id="login-layer" class="full-layer">
        <h1 style="color:white; margin-bottom:30px; font-size: 2.5rem;">é«˜é€Ÿå†³æ–—<br><span style="font-size:1.2rem; color:#2ed573">FINAL MIX</span></h1>
        <input type="text" id="login-input" placeholder="è¾“å…¥åå­—" maxlength="8">
        <button class="action-btn" onclick="tryLogin()">Start Game</button>
    </div>

    <div id="result-layer" class="full-layer hidden">
        <h1 id="result-title" style="font-size:3rem; color:white; text-transform:uppercase;">END</h1>
        <p id="result-desc" style="color:#ccc; font-size:1.2rem; margin-bottom:20px;">...</p>
        <button class="action-btn" style="background:#3742fa" onclick="playAgain()">å†æ¥ä¸€å±€</button>
    </div>

    <div id="crit-overlay"></div>

    <div id="battle-layer">
        <div id="bat-left" class="battle-icon icon-left">âœŠ</div>
        <div id="bat-right" class="battle-icon icon-right">âœŒï¸</div>
    </div>

    <div id="status-bar">WAITING...</div>

    <div class="arena" id="arena">
        <div class="player-zone myself" id="my-zone">
            <div class="bubble" id="my-bubble"></div>
            <div class="player-name" id="my-name">Me</div>
            <div class="hp-container"><div class="hp-bar" id="my-hp-bar"></div></div>
            <div class="hp-text"><span id="my-hp-txt">10</span></div>
        </div>
        <div class="timer-zone"><div id="timer">0.00</div></div>
        <div class="player-zone" id="op-zone">
            <div class="bubble" id="op-bubble"></div>
            <div class="player-name" id="op-name">Opponent</div>
            <div class="hp-container"><div class="hp-bar" id="op-hp-bar"></div></div>
            <div class="hp-text"><span id="op-hp-txt">10</span></div>
        </div>
    </div>

    <div id="crit-controls">
        <div id="btn-smash" onclick="handleSmash()" style="display:none">SMASH!</div>
        <div id="defend-msg" style="display:none">DEFEND!</div>
    </div>

    <div class="controls">
        <button class="btn-move" id="btn-rock" onclick="onLocalMove('rock')">âœŠ</button>
        <button class="btn-move" id="btn-scissors" onclick="onLocalMove('scissors')">âœŒï¸</button>
        <button class="btn-move" id="btn-paper" onclick="onLocalMove('paper')">âœ‹</button>
    </div>

    <script>
        const socket = io({ transports: ['websocket'], autoConnect: false });
        const movesIcon = { 'rock': 'âœŠ', 'scissors': 'âœŒï¸', 'paper': 'âœ‹' };
        let myId, opId, roomId;
        let config = {};
        let timeOffset = 0;
        let nextPhaseTimestamp = 0;
        let isTimerRunning = false;
        
        let isCritMode = false;
        let isAttacker = false;
        let currentHpMap = {};
        let timerDeps = []; 

        const els = {
            timer: document.getElementById('timer'),
            statusBar: document.getElementById('status-bar'),
            arena: document.getElementById('arena'),
            myHpBar: document.getElementById('my-hp-bar'), opHpBar: document.getElementById('op-hp-bar'),
            myHpTxt: document.getElementById('my-hp-txt'), opHpTxt: document.getElementById('op-hp-txt'),
            loginLayer: document.getElementById('login-layer'), resultLayer: document.getElementById('result-layer'),
            batLeft: document.getElementById('bat-left'), batRight: document.getElementById('bat-right'),
            battleLayer: document.getElementById('battle-layer'),
            btns: document.querySelectorAll('.btn-move'),
            btnSmash: document.getElementById('btn-smash'),
            defendMsg: document.getElementById('defend-msg'),
            body: document.body
        };

        function clearAllTimers() {
            timerDeps.forEach(t => clearTimeout(t));
            timerDeps = [];
        }

        function safeSetTimeout(fn, ms) {
            const t = setTimeout(fn, ms);
            timerDeps.push(t);
            return t;
        }

        function tryLogin() {
            const name = document.getElementById('login-input').value || "Player";
            els.loginLayer.classList.add('hidden');
            socket.io.opts.query = { name };
            socket.connect();
        }

        socket.on('connect', () => {
            myId = socket.id;
            socket.emit('syncTime', Date.now(), (data) => {
                timeOffset = data.serverTime - (Date.now() - (Date.now() - Date.now())/2);
            });
        });

        socket.on('gameStart', (data) => {
            clearAllTimers();
            roomId = data.roomId;
            config = data.config;
            const ids = data.players;
            opId = ids.find(id => id !== myId);
            document.getElementById('my-name').textContent = data.names[myId] || "Me";
            document.getElementById('op-name').textContent = data.names[opId] || "Opponent";
            els.resultLayer.classList.add('hidden');
            els.loginLayer.classList.add('hidden');
            resetUIFull();
            updateHpUI(data.hp[myId], data.hp[opId]);
            currentHpMap = data.hp;
            nextPhaseTimestamp = data.nextPhaseTime;
            isTimerRunning = true;
            els.statusBar.textContent = "READY...";
            requestAnimationFrame(gameLoop);
        });

        socket.on('newRound', (data) => {
            clearAllTimers();
            resetUIFull(); 
            nextPhaseTimestamp = data.nextPhaseTime;
            els.statusBar.textContent = "CHOOSE!";
        });

        socket.on('roundResult', (data) => {
            clearAllTimers();
            const myMove = data.moves[myId];
            const opMove = data.moves[opId];
            playBattleAnimation(myMove, opMove, data.damages[myId], data.damages[opId]);
            safeSetTimeout(() => {
                currentHpMap = data.hp;
                updateHpUI(data.hp[myId], data.hp[opId]);
                showEmotes(data.damages[myId], data.damages[opId]);
                let msg = "";
                if (data.damages[myId] > 0 && data.damages[opId] > 0) msg = "DOUBLE HIT!";
                else if (data.damages[myId] > 0) msg = "OUCH!";
                else if (data.damages[opId] > 0) msg = "NICE HIT!";
                else msg = "DRAW";
                els.statusBar.textContent = msg;
            }, 800);
        });

        socket.on('critStart', (data) => {
            clearAllTimers();
            resetBattleLayer();
            isCritMode = true;
            isAttacker = (data.attackerId === myId);
            nextPhaseTimestamp = data.nextPhaseTime;
            enterCritModeUI();
        });

        socket.on('critUpdate', (data) => {
            const targetHp = data.hp;
            if (!isAttacker) {
                if (targetHp[myId] < currentHpMap[myId]) {
                     screenShake();
                     if(navigator.vibrate) navigator.vibrate(15);
                     spawnDmgNumber(window.innerWidth/2, window.innerHeight/2, (currentHpMap[myId] - targetHp[myId]).toFixed(1));
                }
            }
            currentHpMap = targetHp;
            updateHpUI(targetHp[myId], targetHp[opId]);
        });

        socket.on('critResult', (data) => {
            clearAllTimers();
            els.btnSmash.style.display = 'none';
            els.defendMsg.style.display = 'none';
            nextPhaseTimestamp = data.nextPhaseTime;
            els.statusBar.textContent = `TOTAL DAMAGE: ${data.totalDmg.toFixed(1)}`;
        });

        socket.on('gameOver', ({ winnerId, reason, afkUserId }) => {
            clearAllTimers();
            isTimerRunning = false;
            exitCritModeUI();
            els.resultLayer.classList.remove('hidden');
            let title = "GAME OVER", desc = "";
            if (reason === 'afk') desc = (afkUserId === myId) ? "You timed out." : "Opponent disconnected.";
            else if (reason === 'ko') desc = "K.O.";
            const titleEl = document.getElementById('result-title');
            if(winnerId === myId) { title = "VICTORY"; titleEl.style.color = "#2ed573"; }
            else if (!winnerId) { title = "DRAW"; titleEl.style.color = "white"; }
            else { title = "DEFEAT"; titleEl.style.color = "#ff4757"; }
            titleEl.textContent = title;
            document.getElementById('result-desc').textContent = desc;
        });

        function onLocalMove(move) {
            if(!roomId) return;
            if(navigator.vibrate) navigator.vibrate(10);
            els.btns.forEach(btn => {
                if(btn.id === `btn-${move}`) btn.classList.add('selected');
                else btn.classList.add('dimmed');
                btn.disabled = true;
            });
            els.statusBar.textContent = "WAITING...";
            socket.emit('makeMove', { roomId, move });
        }

        function handleSmash() {
            if (!isCritMode || !isAttacker) return;
            const opCurrentVis = parseFloat(els.opHpTxt.textContent);
            const dmg = config.CRIT_DMG_PER_TAP || 0.2;
            const newVis = Math.max(0, opCurrentVis - dmg);
            els.opHpTxt.textContent = newVis.toFixed(1);
            els.opHpBar.style.width = (newVis / config.MAX_HP * 100) + "%";
            if(navigator.vibrate) navigator.vibrate(30);
            spawnDmgNumber(window.innerWidth/2, window.innerHeight/3, dmg);
            socket.emit('critTap', { roomId });
        }

        function playBattleAnimation(myMove, opMove, myDmg, opDmg) {
            els.batLeft.textContent = myMove ? movesIcon[myMove] : 'âŒ';
            els.batRight.textContent = opMove ? movesIcon[opMove] : 'âŒ';
            els.battleLayer.classList.add('clash');
            safeSetTimeout(() => {
                const iWin = opDmg > myDmg; 
                const tie = myDmg === opDmg;
                if (tie) { els.batLeft.classList.add('anim-tie'); els.batRight.classList.add('anim-tie'); }
                else if (iWin) { els.batLeft.classList.add('anim-win'); els.batRight.classList.add('anim-lose'); }
                else { els.batLeft.classList.add('anim-lose'); els.batRight.classList.add('anim-win'); }
            }, 400); 
        }

        function enterCritModeUI() {
            els.body.classList.add('mode-crit');
            if (isAttacker) {
                els.arena.classList.add('focus-op');
                els.btnSmash.style.display = 'flex'; els.defendMsg.style.display = 'none';
                els.statusBar.textContent = "SMASH IT !!!";
            } else {
                els.arena.classList.add('focus-me'); 
                els.btnSmash.style.display = 'none'; els.defendMsg.style.display = 'block';
                els.statusBar.textContent = "DEFEND !!!";
            }
        }

        function exitCritModeUI() {
            els.body.classList.remove('mode-crit');
            els.arena.classList.remove('focus-op', 'focus-me');
            els.btnSmash.style.display = 'none'; els.defendMsg.style.display = 'none';
        }

        function resetUIFull() {
            isCritMode = false;
            exitCritModeUI();
            els.btns.forEach(b => { b.disabled = false; b.classList.remove('selected', 'dimmed'); });
            resetBattleLayer();
            document.querySelectorAll('.bubble').forEach(b => b.classList.remove('show'));
        }

        function resetBattleLayer() {
            els.battleLayer.classList.remove('clash');
            els.batLeft.className = 'battle-icon icon-left'; els.batRight.className = 'battle-icon icon-right';
            els.batLeft.textContent = ''; els.batRight.textContent = '';
        }

        function updateHpUI(myHp, opHp) {
            if(myHp === undefined || opHp === undefined) return;
            els.myHpTxt.textContent = myHp.toFixed(1); els.opHpTxt.textContent = opHp.toFixed(1);
            els.myHpBar.style.width = (myHp / config.MAX_HP * 100) + "%"; els.opHpBar.style.width = (opHp / config.MAX_HP * 100) + "%";
        }

        function showEmotes(myDmg, opDmg) {
            const myBub = document.getElementById('my-bubble'); const opBub = document.getElementById('op-bubble');
            if (myDmg > 0) myBub.textContent = 'ğŸ˜­'; else if (opDmg > 0) myBub.textContent = 'ğŸ˜'; else myBub.textContent = 'ğŸ˜';
            if (opDmg > 0) opBub.textContent = 'ğŸ˜­'; else if (myDmg > 0) opBub.textContent = 'ğŸ˜ˆ'; else opBub.textContent = 'ğŸ˜';
            myBub.classList.add('show'); opBub.classList.add('show');
        }

        function playAgain() {
            socket.emit('playAgain');
            els.resultLayer.classList.add('hidden');
        }

        function gameLoop() {
            if (!isTimerRunning) return;
            const currentServerTime = Date.now() + timeOffset;
            let remaining = (nextPhaseTimestamp - currentServerTime) / 1000;
            if (remaining < 0) remaining = 0;
            els.timer.style.color = isCritMode ? "#ff4757" : "white";
            els.timer.textContent = remaining.toFixed(1);
            requestAnimationFrame(gameLoop);
        }

        function spawnDmgNumber(x, y, amount) {
            const el = document.createElement('div'); el.className = 'dmg-popup'; el.textContent = `-${amount}`;
            const offsetX = (Math.random() - 0.5) * 60;
            el.style.left = (x + offsetX) + 'px'; el.style.top = y + 'px';
            document.body.appendChild(el); setTimeout(() => el.remove(), 800);
        }
        
        function screenShake() {
            els.body.classList.remove('shake-screen'); void els.body.offsetWidth; els.body.classList.add('shake-screen');
            setTimeout(() => { els.body.classList.remove('shake-screen'); }, 500);
        }
    </script>
</body>
</html>